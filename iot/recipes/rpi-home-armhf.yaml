# ParrotOS ARM builder recipe
# Device: Raspberry Pi armhf

steps:
  - mkimg: "{{ output }}"
    size: 7000M

  - mklabel: msdos
    device: "{{ output }}"

  - mkpart: primary
    fs-type: 'fat32'
    device: "{{ output }}"
    start: 4MiB
    end: 256MiB
    tag: /boot

  - mkpart: primary
    device: "{{ output }}"
    start: 300MiB
    end: 100%
    tag: /

  - kpartx: "{{ output }}"

  - mkfs: vfat
    partition: /boot
    label: BOOT

  - mkfs: ext4
    partition: /
    label: ROOTFS

  - mount: /

  - mount: /boot
    mount-on: /
    dirname: '/boot/firmware'

  - unpack-rootfs: /

  - qemu-debootstrap: parrot
    mirror: http://deb.parrot.sh/direct/parrot
    target: /
    arch: armhf
    unless: rootfs_unpacked

  - chroot: /
    shell: |
      apt update
    unless: rootfs_unpacked

  # Core system
  - apt: install
    packages:
    - gnupg
    - ca-certificates
    - parrot-core
    - base-files
    - pciutils
    - usbutils
    - iw
    - mdadm
    - parted
    - bash-completion
    - rng-tools5
    - haveged
    - inxi
    - htop
    - nload
    - iftop
    tag: /
    unless: rootfs_unpacked

  # Basic packages for home edition
  - apt: install
    packages:
    - openssh-server
    - sudo
    - network-manager
    - cloud-guest-utils
    - firmware-brcm80211
    - raspberrypi-kernel
    - raspberrypi-kernel-headers
    - raspberrypi-bootloader
    - raspi-firmware
    - raspi-config
    - parrot-desktop-mate
    - chromium-
    - mate-user-guide-
    - pocketsphinx-en-us-
    - libreoffice-help-en-us-
    - mythes-en-us-
    - libreoffice-help-common-
    - espeak-ng-data-
    tag: /
    unless: rootfs_unpacked

  # set-system.sh config file
  - copy-file: /tmp/set-system.sh
    src: config/set-system.sh
    perm: 755
    unless: rootfs_unpacked

  - copy-file: /tmp/default.conf
    src: work_dir/default.conf
    perm: 644
    unless: rootfs_unpacked

  - chroot: /
    shell: |
      bash /tmp/set-system.sh
      rm /tmp/set-system.sh /tmp/default.conf
    unless: rootfs_unpacked

  - root-fs: /
    shell: |
      # Install /boot config and fstab
      install -m 644 -o root -g root rootfs/etc/fstab "${ROOT?}/etc/fstab"
      install -m 644 -o root -g root rootfs/boot/firmware/sysconf.txt "${ROOT?}/boot/firmware/sysconf.txt"
      install -m 644 -o root -g root rootfs/boot/cmdline.txt "${ROOT?}/boot/cmdline.txt"
      install -m 644 -o root -g root rootfs/boot/config.txt "${ROOT?}/boot/config.txt"

      rsync -a --exclude=firmware --exclude=overlays ${ROOT?}/boot/ ${ROOT?}/boot/firmware/

  # Systemd service to get resize2fs working
  - copy-file: /etc/systemd/system/firstboot.service
    src: rootfs/etc/systemd/system/firstboot.service
    perm: 644
    unless: rootfs_unpacked
    
  - chroot: /
    shell: |
      systemctl enable firstboot.service ssh.service
    
  - chroot: /
    shell: |
      rm -rf /etc/machine-id /var/lib/dbus/machine-id /var/cache/apt/*
